{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <div class="header-content">
        <h1>Personal Bank Accounts</h1>
        <div class="header-actions" style="display: flex; gap: 10px;">
            <button onclick="openAddModal()" class="btn-primary">+ Add New Account</button>
            <button onclick="openEnterpriseModal()" class="btn-primary">+ Add Current Account</button>
        </div>
    </div>
</div>

<!-- Personal Savings Accounts -->
<div class="dashboard-section card">
    <div class="bank-grid">
        {% for bank in banks %}
        <div class="bank-card">
            <!-- Header -->
            <div class="bank-card-header">
                <div class="bank-identity">
                    <div class="bank-icon-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                    <div class="bank-title-group">
                        <h3>{{ bank.bank_name }}</h3>
                        <div class="bank-sublink" data-id="{{ bank.id }}" data-bank="{{ bank.bank_name }}"
                            data-acct="{{ bank.account_number }}" data-ifsc="{{ bank.ifsc_code }}"
                            data-bal="{{ bank.opening_balance }}"
                            onclick="openEditModal({id: this.getAttribute('data-id'), bank_name: this.getAttribute('data-bank'), account_number: this.getAttribute('data-acct'), ifsc_code: this.getAttribute('data-ifsc'), opening_balance: this.getAttribute('data-bal')})">
                            Edit Details
                        </div>
                    </div>
                </div>

                <div class="card-actions">
                    <a href="{{ url_for('delete_bank', bank_id=bank.id) }}" class="btn-icon-only delete"
                        onclick="return confirm('Remove this bank account?')" title="Remove">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            stroke-width="2" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </a>
                </div>
            </div>

            <!-- Body: Details -->
            <div class="bank-card-body">
                <div class="detail-item">
                    <span class="detail-label">Account Num</span>
                    <span class="detail-value">{{ bank.account_number }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">IFSC Code</span>
                    <span class="detail-value">{{ bank.ifsc_code }}</span>
                </div>
            </div>

            <!-- Footer: Balance -->
            <div class="bank-card-footer">
                <div class="balance-group">
                    <span class="balance-label">Opening Balance</span>
                    <span class="balance-amount">{{ "%.2f"|format(bank.opening_balance or 0) }}</span>
                </div>
                <div class="balance-group" style="text-align: right;">
                    <span class="balance-label">Current Balance</span>
                    <span class="balance-amount" style="color: var(--brand-start);">{{
                        "%.2f"|format(bank.current_balance) }}</span>
                </div>
            </div>
        </div>
        {% else %}
        <p>No bank accounts added yet.</p>
        {% endfor %}
    </div>
</div>

<!-- Business & Credit Accounts Section -->
<div class="dashboard-header" style="margin-top: 40px;">
    <div class="header-content">
        <h1>Business &amp; Credit Accounts</h1>
    </div>
</div>

<div class="dashboard-section card">
    <div class="bank-grid">
        {% if enterprise_banks %}
        {% for bank in enterprise_banks %}
        <div class="bank-card">
            <div class="bank-card-header">
                <div class="bank-identity">
                    <div class="bank-icon-placeholder" style="background: linear-gradient(135deg, #10b981, #8b5cf6);">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div class="bank-title-group">
                        <h3><strong style="font-weight: 700;">{{ bank.business_name }}</strong> - {{ bank.bank_name }}
                            {% if bank.account_type == 'Current' %}
                            <span
                                style="background: #10b981; color: white; border-radius: 4px; padding: 2px 8px; font-size: 0.65em; font-weight: 600; vertical-align: middle; margin-left: 5px;">CURRENT</span>
                            {% elif bank.account_type == 'CC/OD' %}
                            <span
                                style="background: #8b5cf6; color: white; border-radius: 4px; padding: 2px 8px; font-size: 0.65em; font-weight: 600; vertical-align: middle; margin-left: 5px;">CC/OD</span>
                            {% endif %}
                        </h3>
                    </div>
                </div>

                <div class="card-actions">
                    <a href="{{ url_for('delete_enterprise_bank', bank_id=bank.id) }}" class="btn-icon-only delete"
                        onclick="return confirm('Remove this business account?')" title="Remove">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                            stroke-width="2" width="16" height="16">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </a>
                </div>
            </div>

            <div class="bank-card-body">
                <div class="detail-item">
                    <span class="detail-label">Account Num</span>
                    <span class="detail-value">{{ bank.account_number }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">IFSC Code</span>
                    <span class="detail-value">{{ bank.ifsc_code }}</span>
                </div>
            </div>

            <div class="bank-card-footer">
                <div class="balance-group">
                    <span class="balance-label">Opening Balance</span>
                    <span class="balance-amount">{{ "%.2f"|format(bank.opening_balance or 0) }}</span>
                </div>
                <div class="balance-group" style="text-align: right;">
                    <span class="balance-label">Current Balance</span>
                    <span class="balance-amount" style="color: var(--brand-start);">{{
                        "%.2f"|format(bank.current_balance or 0) }}</span>
                </div>
            </div>
            <button class="btn-primary" style="width: 100%; margin-top: 0.75rem;"
                data-business-name="{{ bank.business_name }}"
                onclick="openBusinessAuth(this.getAttribute('data-business-name'))">Manage Business →</button>
        </div>
        {% endfor %}
        {% else %}
        <div
            style="width: 100%; grid-column: 1 / -1; padding: 40px; text-align: center; background: rgba(0,0,0,0.02); border: 1px dashed rgba(0,0,0,0.1); border-radius: 12px; opacity: 0.6; font-style: italic;">
            No business accounts linked yet.
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit Personal Bank Modal -->
<div id="bank-modal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal()" class="close">&times;</span>
        <h2 id="modal-title">Add Bank Account</h2>
        <form id="bank-form" action="{{ url_for('add_bank') }}" method="POST">
            <div class="form-group">
                <label>Bank Name</label>
                <input type="text" id="bank_name" name="bank_name" placeholder="e.g. HDFC Bank" required>
            </div>
            <div class="form-group">
                <label>Account Number</label>
                <input type="number" id="account_number" name="account_number" placeholder="XXXX-XXXX-XXXX" required>
            </div>
            <div class="form-group">
                <label>IFSC Code</label>
                <input type="text" id="ifsc_code" name="ifsc_code" placeholder="HDFC0001234" required>
            </div>
            <div class="form-group">
                <label>Opening Balance</label>
                <input type="number" id="opening_balance" name="opening_balance" placeholder="0.00" step="0.01"
                    value="0">
            </div>
            <div class="modal-footer" style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="button" onclick="closeModal()" class="btn-secondary" style="flex: 1;">Cancel</button>
                <button type="submit" id="modal-submit-btn" class="btn-primary" style="flex: 2;">Add Account</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Enterprise Bank Modal (Separate — unique IDs) -->
<div id="enterprise-bank-modal" class="modal">
    <div class="modal-content">
        <span onclick="closeEnterpriseModal()" class="close">&times;</span>
        <h2 id="ent-modal-title">Add Business Account</h2>
        <form id="ent-bank-form" action="{{ url_for('add_enterprise_bank') }}" method="POST">
            <div class="form-group">
                <label>Business Name</label>
                <input type="text" id="ent_business_name" name="business_name" placeholder="e.g. My Agency" required>
            </div>
            <div class="form-group">
                <label>Account Type</label>
                <select id="ent_account_type" name="account_type" required>
                    <option value="Current">Current Account (Liquid)</option>
                    <option value="CC/OD">CC/OD Account (Credit/Overdraft)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Bank Name</label>
                <input type="text" id="ent_bank_name" name="bank_name" placeholder="e.g. HDFC Business" required>
            </div>
            <div class="form-group">
                <label>Account Number</label>
                <input type="number" id="ent_account_number" name="account_number" placeholder="XXXX-XXXX-XXXX"
                    required>
            </div>
            <div class="form-group">
                <label>IFSC Code</label>
                <input type="text" id="ent_ifsc_code" name="ifsc_code" placeholder="HDFC0001234" required>
            </div>
            <div class="form-group">
                <label>Opening Balance</label>
                <input type="number" id="ent_opening_balance" name="opening_balance" placeholder="0.00" step="0.01"
                    value="0.00">
            </div>
            <div class="modal-footer" style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="button" onclick="closeEnterpriseModal()" class="btn-secondary"
                    style="flex: 1;">Cancel</button>
                <button type="submit" id="ent-modal-submit-btn" class="btn-primary" style="flex: 2;">Add Business
                    Account</button>
            </div>
        </form>
    </div>
</div>

<script>
    // --- Personal Bank Modal ---
    const modal = document.getElementById('bank-modal');
    const form = document.getElementById('bank-form');
    const title = document.getElementById('modal-title');
    const submitBtn = document.getElementById('modal-submit-btn');

    function openAddModal() {
        modal.style.display = "block";
        title.innerText = "Add Bank Account";
        submitBtn.innerText = "Add Account";
        form.action = "{{ url_for('add_bank') }}";
        form.reset();
        document.getElementById('opening_balance').value = "0";
    }

    function openEditModal(bank) {
        modal.style.display = "block";
        title.innerText = "Edit Bank Account";
        submitBtn.innerText = "Update Account";
        form.action = "/edit_bank/" + bank.id;

        document.getElementById('bank_name').value = bank.bank_name;
        document.getElementById('account_number').value = bank.account_number;
        document.getElementById('ifsc_code').value = bank.ifsc_code;
        document.getElementById('opening_balance').value = bank.opening_balance || 0;
    }

    function closeModal() {
        modal.style.display = "none";
    }

    // --- Enterprise Bank Modal ---
    const entModal = document.getElementById('enterprise-bank-modal');
    const entForm = document.getElementById('ent-bank-form');
    const entTitle = document.getElementById('ent-modal-title');
    const entSubmitBtn = document.getElementById('ent-modal-submit-btn');

    function openEnterpriseModal() {
        entModal.style.display = "block";
        entTitle.innerText = "Add Business Account";
        entSubmitBtn.innerText = "Add Business Account";
        entForm.action = "{{ url_for('add_enterprise_bank') }}";
        entForm.reset();
        document.getElementById('ent_business_name').value = "";
        document.getElementById('ent_opening_balance').value = "0";
    }

    function closeEnterpriseModal() {
        entModal.style.display = "none";
    }

    // Close on outside click
    window.onclick = function (event) {
        if (event.target === modal) closeModal();
        if (event.target === entModal) closeEnterpriseModal();
        const authModal = document.getElementById('business-auth-modal');
        if (event.target === authModal) closeBusinessAuth();
    }
</script>


<!-- Business Auth (Double Login) Modal -->
<div id="business-auth-modal" class="modal">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <span onclick="closeBusinessAuth()" class="close">&times;</span>
        <h2 id="business-auth-title" style="margin-bottom: 0.5rem; color: var(--text-primary);">Business Access</h2>
        <p id="business-auth-subtitle" style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.95rem;">
            Securing access to <strong id="business-auth-name-display" style="color: var(--brand-start);"></strong>
        </p>

        <!-- Loading State -->
        <div id="business-auth-loader" style="display: none; padding: 2rem 0;">
            <div
                style="width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid var(--brand-start); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;">
            </div>
            <p style="margin-top: 1rem; color: var(--text-secondary);">Verifying security status...</p>
        </div>

        <form id="business-auth-form" method="POST" style="display: none;">
            <input type="hidden" id="auth_business_name" name="business_name">

            <div id="pin-login-group" class="form-group" style="text-align: left;">
                <label>Security PIN <span style="color: red;">*</span></label>
                <input type="password" name="password" id="auth_password" placeholder="Enter Business PIN" required>
            </div>

            <div id="auth-confirm-group" class="form-group" style="display: none; text-align: left;">
                <label>Confirm PIN <span style="color: red;">*</span></label>
                <input type="password" name="confirm_password" id="auth_confirm_password"
                    placeholder="Confirm Security PIN">
                <p style="font-size: 0.8rem; color: var(--text-tertiary); margin-top: 0.25rem;">
                    You are setting up a secure PIN for this business for the first time.
                </p>
            </div>

            <!-- New Reset PIN Group -->
            <div id="auth-reset-group" style="display: none; text-align: left;">
                <div class="form-group">
                    <label>Account Password <span style="color: red;">*</span></label>
                    <input type="password" name="account_password" id="auth_account_password"
                        placeholder="Your primary login password">
                    <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.2rem;">Verify ownership
                        with your main account password.</p>
                </div>
                <div class="form-group">
                    <label>New Security PIN <span style="color: red;">*</span></label>
                    <input type="password" name="new_pin" id="auth_new_pin" placeholder="Enter new 4-6 digit PIN">
                </div>
                <div class="form-group">
                    <label>Confirm New PIN <span style="color: red;">*</span></label>
                    <input type="password" name="confirm_pin" id="auth_new_confirm" placeholder="Confirm new PIN">
                </div>
            </div>

            <div id="forgot-pin-container" style="text-align: right; margin-bottom: 1rem; display: none;">
                <a href="javascript:void(0)" onclick="togglePinReset(true)"
                    style="font-size: 0.85rem; color: var(--brand-start); text-decoration: none;">Forgot Security
                    PIN?</a>
            </div>
            <div id="back-to-login-container" style="text-align: left; margin-bottom: 1rem; display: none;">
                <a href="javascript:void(0)" onclick="togglePinReset(false)"
                    style="font-size: 0.85rem; color: var(--text-tertiary); text-decoration: none;">&larr; Back to
                    Login</a>
            </div>

            <button type="submit" id="business-auth-submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">
                Access Dashboard
            </button>
        </form>
    </div>
</div>

<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    const authModal = document.getElementById('business-auth-modal');
    const authForm = document.getElementById('business-auth-form');
    const authLoader = document.getElementById('business-auth-loader');
    const authTitle = document.getElementById('business-auth-title');
    const confirmGroup = document.getElementById('auth-confirm-group');
    const confirmInput = document.getElementById('auth_confirm_password');
    const authSubmitBtn = document.getElementById('business-auth-submit');
    const resetGroup = document.getElementById('auth-reset-group');
    const forgotContainer = document.getElementById('forgot-pin-container');
    const backContainer = document.getElementById('back-to-login-container');
    const pinGroup = document.getElementById('pin-login-group');

    async function openBusinessAuth(businessName) {
        authModal.style.display = "block";
        document.getElementById('business-auth-name-display').innerText = businessName;
        document.getElementById('auth_business_name').value = businessName;

        // Reset state
        authForm.reset();
        authForm.style.display = "none";
        authLoader.style.display = "block";
        togglePinReset(false); // Ensure we start in normal mode

        try {
            // Encode safely for URL passing without Vercel breaking query params
            const encodedName = btoa(unescape(encodeURIComponent(businessName)));

            // Check if user has a PIN registered for this business
            const response = await fetch(`/enterprise/check_auth?bname=${encodedName}`);
            const data = await response.json();

            authLoader.style.display = "none";
            authForm.style.display = "block";

            if (data.registered) {
                // Login Mode
                authTitle.innerText = "Unlock Business";
                confirmGroup.style.display = "none";
                confirmInput.required = false;
                forgotContainer.style.display = "block";
                authSubmitBtn.innerText = "Access Dashboard";
                authForm.action = "/enterprise/login";
            } else {
                // Setup / Signup Mode
                authTitle.innerText = "Setup Security PIN";
                confirmGroup.style.display = "block";
                confirmInput.required = true;
                forgotContainer.style.display = "none";
                authSubmitBtn.innerText = "Set PIN & Continue";
                authForm.action = "/enterprise/signup";
            }

            // Focus password field automatically
            setTimeout(() => document.getElementById('auth_password').focus(), 100);

        } catch (error) {
            console.error("Auth check failed:", error);
            authTitle.innerText = "Error";
            authLoader.innerHTML = "<p style='color:red;'>Could not contact server. Please refresh.</p>";
        }
    }

    function togglePinReset(showReset) {
        if (showReset) {
            authTitle.innerText = "Reset Security PIN";
            pinGroup.style.display = "none";
            resetGroup.style.display = "block";
            forgotContainer.style.display = "none";
            backContainer.style.display = "block";
            authForm.action = "/enterprise/reset_pin";
            authSubmitBtn.innerText = "Reset PIN Now";

            // Set required fields
            document.getElementById('auth_account_password').required = true;
            document.getElementById('auth_new_pin').required = true;
            document.getElementById('auth_new_confirm').required = true;
            document.getElementById('auth_password').required = false;
        } else {
            // Restore Login/Signup state will be handled by openBusinessAuth
            // but for toggle back, we specifically restore Login look
            pinGroup.style.display = "block";
            resetGroup.style.display = "none";
            backContainer.style.display = "none";

            document.getElementById('auth_account_password').required = false;
            document.getElementById('auth_new_pin').required = false;
            document.getElementById('auth_new_confirm').required = false;
            document.getElementById('auth_password').required = true;

            // Note: openBusinessAuth will fix Titles/Actions/Buttons correctly
        }
    }

    function closeBusinessAuth() {
        authModal.style.display = "none";
    }
</script>
{% endblock %}