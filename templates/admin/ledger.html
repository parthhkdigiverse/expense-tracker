{% extends "admin/layout.html" %}

{% block content %}
<div class="dashboard-header" style="margin-bottom: 20px;">
    <div class="header-content">
        <h1>Global Transaction Ledger</h1>
        <p style="color: var(--text-secondary); margin-top: 5px;">Master view of all enterprise financial activity.</p>
    </div>
</div>

<div class="admin-table-container">
    <table class="admin-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Business Name</th>
                <th>User / Owner</th>
                <th>Type</th>
                <th>Category / Status</th>
                <th>Amount</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for tx in transactions %}
            <tr>
                <td>{{ tx.date }}</td>
                <td style="font-weight: 500;">{{ tx.business_name }}</td>
                <td>{{ tx.taken_by or "Unknown" }}</td>
                <td>
                    {% if tx.type == 'revenue' %}
                    <span
                        style="color: #10b981; font-weight: bold; background: rgba(16, 185, 129, 0.1); padding: 2px 8px; border-radius: 12px; font-size: 0.8em; text-transform: uppercase;">Revenue</span>
                    {% else %}
                    <span
                        style="color: #ef4444; font-weight: bold; background: rgba(239, 68, 68, 0.1); padding: 2px 8px; border-radius: 12px; font-size: 0.8em; text-transform: uppercase;">Expense</span>
                    {% endif %}
                </td>
                <td>{{ tx.category }}</td>
                <td style="font-weight: 600; color: {{ '#10b981' if tx.type == 'revenue' else '#ef4444' }};">
                    {{ 'â‚¹{:,.2f}'.format(tx.amount|float) }}
                </td>
                <td style="display: flex; gap: 8px;">
                    <button type="button" class="btn-primary"
                        style="padding: 4px 10px; border-radius: 4px; font-size: 0.85em;"
                        onclick="openEditModal('{{ tx.id }}', '{{ tx.type }}', '{{ tx.amount }}', '{{ tx.category }}', '{{ tx.date }}')">Edit</button>

                    <form method="POST"
                        action="{{ url_for('admin.delete_ledger_transaction', trans_type=tx.type, transaction_id=tx.id) }}"
                        style="display:inline;">
                        <button type="submit" class="btn-danger"
                            style="padding: 4px 10px; border-radius: 4px; font-size: 0.85em;"
                            onclick="return confirm('Are you sure you want to delete this transaction from the global ledger? This cannot be undone.');">Delete</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: var(--text-secondary);">No transactions
                    recorded in the ledger.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Edit Transaction Modal -->
<div id="editTransactionModal" class="modal-overlay" style="display: none;">
    <div class="modal-content"
        style="max-width: 400px; background: var(--bg-secondary); border-radius: 12px; padding: 24px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 10px 25px rgba(0,0,0,0.5);">
        <h2 style="margin-bottom: 20px; font-size: 1.2rem;">Edit Transaction</h2>
        <form id="editTransactionForm" method="POST" action="">
            <div style="margin-bottom: 15px;">
                <label
                    style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9em;">Amount</label>
                <input type="number" step="0.01" name="amount" id="edit_amount"
                    style="width: 100%; padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white;"
                    required>
            </div>
            <div style="margin-bottom: 15px;">
                <label
                    style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9em;">Category
                    / Status</label>
                <input type="text" name="category" id="edit_category"
                    style="width: 100%; padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white;"
                    required>
            </div>
            <div style="margin-bottom: 20px;">
                <label
                    style="display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9em;">Date</label>
                <input type="date" name="date" id="edit_date"
                    style="width: 100%; padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white;"
                    required>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" class="btn-secondary" onclick="closeEditModal()"
                    style="padding: 8px 16px; background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 6px;">Cancel</button>
                <button type="submit" class="btn-primary" style="padding: 8px 16px; border-radius: 6px;">Save
                    Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openEditModal(trans_id, trans_type, amount, category, date) {
        document.getElementById('edit_amount').value = parseFloat(amount).toFixed(2);
        document.getElementById('edit_category').value = category;
        document.getElementById('edit_date').value = date;

        let form = document.getElementById('editTransactionForm');
        form.action = `/admin/ledger/edit/${trans_type}/${trans_id}`;

        document.getElementById('editTransactionModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editTransactionModal').style.display = 'none';
    }
</script>
{% endblock %}